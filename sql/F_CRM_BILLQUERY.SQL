CREATE FUNCTION [POSV3].[F_CRM_BILLQUERY](
@P_EID VARCHAR(50),
@P_MemberID VARCHAR(50),
@P_CardNo VARCHAR(50),
@P_BeginDate VARCHAR(50),
@P_EndDate VARCHAR(50)
)
RETURNS @T_BillQuery_TABLE TABLE (
BILLTYPE VARCHAR(20),
BILLNAME VARCHAR(50),
BILLNO VARCHAR(50),
SOURCEBILLNO VARCHAR(50),
TERMINALID VARCHAR(50),
DESCRIPTION VARCHAR(200),
ORGTYPE VARCHAR(20),
ORGID VARCHAR(50),
ORGNAME VARCHAR(100),
PAYTYPE VARCHAR(10),
PAYNAME VARCHAR(50),
PAYNO VARCHAR(50),
AMOUNT NUMERIC(18,4),
POINT NUMERIC(18,4),
BILLDATE DATETIME,
BILLTIME DATETIME
)
AS
BEGIN

DECLARE @t T_BillQuery_TABLE;

DECLARE @V_SQL NVARCHAR(MAX);

DECLARE @V_BillType VARCHAR(20);
DECLARE @V_BillName VARCHAR(50);
DECLARE @V_BillNo VARCHAR(50);
DECLARE @V_SOURCEBILLNO VARCHAR(50);
DECLARE @V_TerminalID VARCHAR(50);
DECLARE @V_DESCRIPTION VARCHAR(200);
DECLARE @V_ORGTYPE VARCHAR(20);
DECLARE @V_ORGID VARCHAR(50);
DECLARE @V_ORGNAME VARCHAR(100);
DECLARE @V_PAYTYPE VARCHAR(10);
DECLARE @V_PAYNAME VARCHAR(50);
DECLARE @V_PAYNO VARCHAR(50);
DECLARE @V_AMOUNT NUMERIC(18,4);
DECLARE @V_POINT NUMERIC(18,4);
DECLARE @V_BILLDATE DATETIME;
DECLARE @V_BILLTIME DATETIME;

SET @V_SQL = ''
+ 'SELECT a.DIRECT, a.BILLTYPE, COALESCE(b.BILLTYPENAME, REASONID) BILLNAME, a.BILLNO, d.BILLNO as SOURCEBILLNO, a.TERMINALID, a.DESCRIPTION,''2'' ORGTYPE, a.SHOPID ORGID, '''' ORGNAME, ''1'' PAYTYPE, ''卡'' PAYNAME, a.CARDNO PAYNO, '
+ '(CASE a.ACCOUNTTYPE WHEN 1 THEN a.DIRECTa.CHANGEVALUE ELSE 0 END) AMOUNT, '
+ '(CASE a.ACCOUNTTYPE WHEN 3 THEN a.DIRECTa.CHANGEVALUE ELSE 0 END) POINT, '
+ 'a.CREATETIME BILLDATE, a.CREATETIME BILLTIME '
+ 'FROM CRM_CARDACCOUNTCHANGE a '
+ 'LEFT JOIN CRM_BILLTYPE b ON a.BILLTYPE=b.BILLTYPE '
+ 'LEFT JOIN DCP_ORG s ON a.EID = s.EID AND a.SHOPID = s.ORGANIZATIONNO '
+ 'LEFT JOIN CRM_CARD c ON a.EID = c.EID AND a.CARDID = c.CARDID '
+ 'LEFT JOIN CRM_CONSUME_CARD d ON a.EID = d.EID AND a.BILLNO = d.CARDBILLNO AND a.BILLTYPE=''CRM016'' '
+ 'WHERE a.EID=''' + P_EID + ''' '
+ 'AND a.BILLDATE >= CONVERT(DATETIME, ''' + P_BeginDate + ''', 120) '
+ 'AND a.BILLDATE <= CONVERT(DATETIME, ''' + P_EndDate + ''', 120) '
+ 'AND a.BILLTYPE <> ''CRM002'' AND a.BILLTYPE <> ''CRM004'' ';

IF P_MemberID IS NOT NULL
BEGIN
SET @V_SQL = @V_SQL + 'AND c.MEMBERID = ''' + P_MemberID + ''' ';
END

IF P_CardNo IS NOT NULL
BEGIN
SET @V_SQL = @V_SQL + 'AND a.CARDNO = ''' + P_CardNo + ''' ';
END

SET @V_SQL = ''
+ 'SELECT BILLTYPE, BILLNAME, BILLNO, SOURCEBILLNO, TERMINALID, DESCRIPTION, ORGTYPE, ORGID, ORGNAME, PAYTYPE, PAYNAME, PAYNO, '
+ 'SUM(AMOUNT) AMOUNT, SUM(POINT) POINT, MAX(BILLDATE) BILLDATE, MAX(BILLTIME) BILLTIME '
+ 'FROM (' + @V_SQL + ') '
+ 'GROUP BY DIRECT, BILLTYPE, BILLNAME, BILLNO, SOURCEBILLNO, TERMINALID, DESCRIPTION, ORGTYPE, ORGID, ORGNAME, PAYTYPE, PAYNAME, PAYNO '
+ 'ORDER BY BILLTIME';


SET @V_SQL = N'SELECT V_BillType,V_BillName,V_BillNo,V_SOURCEBILLNO,V_TerminalID,V_DESCRIPTION,V_ORGTYPE,V_ORGID,V_ORGNAME,V_PAYTYPE,V_PAYNAME,V_PAYNO,V_AMOUNT,V_POINT,V_BILLDATE,V_BILLTIME FROM ...'; -- 使用 SELECT 代替原始的 V_SQL

INSERT INTO @t (BILLTYPE,BILLNAME,BILLNO,SOURCEBILLNO,TERMINALID,DESCRIPTION,ORGTYPE,ORGID,ORGNAME,PAYTYPE,PAYNAME,PAYNO,AMOUNT,POINT,BILLDATE,BILLTIME)
EXEC sp_executesql @V_SQL;

SELECT * FROM @t;
