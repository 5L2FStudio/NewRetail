CREATE FUNCTION [dbo].[F_DCP_GET_SALEQTY_SQL] (
@P_EID VARCHAR(255), --企业
@P_PluNo VARCHAR(255), --品号 或 MastPluNo
@P_FeatureNo VARCHAR(255), --特征码 空格或空表示不区分特征码
@P_OrgID VARCHAR(255), --组织 空则表示不区分机构，取总量
@P_ChannelID VARCHAR(255), --渠道
@P_WAREHOUSE VARCHAR(255), --仓库 空则表示不区分仓库，取机构的总量。
@P_SUnit VARCHAR(255) --交易单位
)
RETURNS NUMERIC(18, 4)
AS
BEGIN
DECLARE @V_BreakPoint VARCHAR(255);
DECLARE @V_Err INT;
DECLARE @V_Msg VARCHAR(255);

DECLARE @V_Temp VARCHAR(64);

DECLARE @V_BASEUNIT VARCHAR(32);

DECLARE @V_OnlineMode INT;
DECLARE @V_OnlineQty NUMERIC(18, 4);
DECLARE @V_OnlineUnit VARCHAR(32);

DECLARE @V_Qty NUMERIC(18, 4);

DECLARE @V_TempCount INT;

DECLARE @V_SQL1 VARCHAR(2000);
DECLARE @V_CHANNELSQL VARCHAR(2000);

DECLARE @V_SQL VARCHAR(2000);

DECLARE @V_MASTERPLUNO VARCHAR(32);

DECLARE @V_STOCKCONTROL INT;

DECLARE @GOODSRANGE TABLE
   (	PLUNO VARCHAR(50), 
	    FEATURENO VARCHAR(64), 
	    UNIT VARCHAR(64)
   );
---BEGIN

SET @V_Err = -20001;
SET @V_BreakPoint = 'F_DCP_GET_SALEQTY_010';

IF @P_ChannelID IS NOT NULL
BEGIN
  SELECT @V_STOCKCONTROL = COALESCE(STOCKCONTROL,1)
    FROM CRM_CHANNEL WHERE EID = @P_EID AND CHANNELID = @P_ChannelID;

  IF @V_STOCKCONTROL = 0
  BEGIN
    RETURN 999999;
  END;
END;

INSERT INTO @GOODSRANGE( PLUNO,  FEATURENO,  UNIT )
  SELECT 
    A.PLUNO,  '', A.UNIT    
  FROM DCP_MSPECGOODS_SUBGOODS A
  LEFT JOIN DCP_GOODS_ONLINE B ON A.EID = B.EID AND A.MASTERPLUNO=B.PLUNO
  WHERE A.EID = P_EID 
    AND A.MASTERPLUNO = P_PluNo AND B.PLUTYPE = 'MULTISPEC';


  SELECT count(*) INTO @V_TempCount FROM @GOODSRANGE;
  IF ( @V_TempCount <= 0 )
  BEGIN
    INSERT INTO @GOODSRANGE( PLUNO,  FEATURENO,  UNIT )
    VALUES ( @P_PluNo,  @P_FeatureNo,  @P_SUnit );    
  END

  DECLARE C1 CURSOR FOR SELECT DISTINCT PLUNO,FEATURENO,UNIT FROM @GOODSRANGE
  OPEN C1
  FETCH NEXT FROM C1 INTO @V_MASTERPLUNO, @V_OnlineUnit, @V_Temp, @V_OnlineQty;
  WHILE @@FETCH_STATUS = 0
  BEGIN

    --1.判断这个渠道的商品是上架模式还是共享模式

    --2.如果是上架模式，可售量取渠道的上架量（上架模式的虚拟库存，在下单时就减掉）
    
    --3.如果是共享库存模式，取库存表（共享模式共享的是实物库存，在下单时就不减掉，只锁定，出货时减）
    

    FETCH NEXT FROM C1 INTO @V_MASTERPLUNO, @V_OnlineUnit, @V_Temp, @V_OnlineQty;
  END
  CLOSE C1;
  DEALLOCATE C1;

  SET @V_Qty = 0;
  DECLARE C1 CURSOR FOR
    SELECT PLUNO,UNIT OnlineUnit,TOUNIT,COALESCE(SUM(QTY),0) OnlineQty
    FROM TMP_GOODSSTOCK
    GROUP BY PLUNO,UNIT,TOUNIT;

  OPEN C1;
  FETCH NEXT FROM C1 INTO @V_MASTERPLUNO, @V_OnlineUnit, @V_Temp, @V_OnlineQty;

  WHILE @@FETCH_STATUS = 0
  BEGIN
    IF @V_OnlineQty <> 0
    BEGIN
      SET @V_Qty = @V_Qty + dbo.F_DCP_UnitConvert(@P_EID, @V_MASTERPLUNO, @V_OnlineUnit, @V_Temp, @V_OnlineQty);
    END;
    FETCH NEXT FROM C1 INTO @V_MASTERPLUNO, @V_OnlineUnit, @V_Temp, @V_OnlineQty;
  END;

  CLOSE C1;
  DEALLOCATE C1;

  --取单位上的小数位数
  RETURN @V_Qty;
END;
